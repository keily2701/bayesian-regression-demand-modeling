---
title: "Análisis estadístico de brotes alimentarios"
author: "Keily Oropeza"
output: html_document
---

## Introducción

Este documento presenta una versión resumida y reproducible del análisis
estadístico desarrollado en mi tesis de grado en Matemática (mención Estadística
y Aplicadas).  
El estudio se centra en el análisis de brotes de enfermedades transmitidas por
alimentos, utilizando datos previamente modificados con fines académicos.

---

## Carga y preparación de los datos

```{r}
# Limpiar entorno
rm(list = ls())

# Librerías
library(glmnet)

# Cargar datos
source("src/load_data.R")
source("eda_multivariate.R")
source("eda_univariate.R")
source("glm_models.R")
source("pca_analysis.R")
source("regularized_models.R")


data_list <- cargar_datos("data/data modificada 5 sem1.csv")

dato1 <- data_list$dato1
vari  <- data_list$variables
```
El conjunto de datos contiene información epidemiológica de brotes de ETA,
incluyendo variables categóricas, binarias y de conteo, las cuales son analizadas
según su naturaleza.
---

## Análisis exploratorio

### Resumen descriptivo global

Se realizó un análisis descriptivo de las variables cuantitativas mediante medidas resumen, rango, desviación estándar y varianza, con el fin de evaluar dispersión, escalas y posibles valores atípicos.

```{r}
summary(dato1)

apply(dato1, 2, range)
apply(dato1, 2, sd)
apply(dato1, 2, var)
```
### Variables binarias
A continuación se presentan algunas visualizaciones descriptivas de variables
seleccionadas, con el fin de identificar patrones iniciales.

```{r}
# Variables binarias
indices_sintomas <- c(29:44)
indices_otras    <- c(6, 55, 56)
indices_binarias <- c( indices_sintomas,indices_otras)

par(mfrow = c(3, 3))
for (i in indices_sintomas) {
  plot_binary_hist(dato1, i)
}

par(mfrow = c(1, 3))

for (i in indices_otras) {
  plot_binary_hist(dato1, i)
}

# Tabla resumen
binary_summary(dato1, indices_binarias)

```
### Variables categóricas
Para las variables categóricas se construyeron histogramas y tablas de frecuencia absoluta y relativa mediante una función auxiliar, lo que permite manejar variables con distinto número de niveles de forma automática.

```{r}
indices_factores <- c(
  1, 4, 5,
  45,46,47,48,49,50,51,52,
  53,54
)
par(mfrow = c(1, 3))# variables-Temporal y geografico

for (i in indices_factores[1:3]) {
  plot_factor_hist(
    dato1,
    i,
    breaks = seq(min(dato1[,i]) - 0.5,
                 max(dato1[,i]) + 0.5,
                 by = 1)
  )
}

par(mfrow = c(2, 4)) # variables- Otros factores

for (i in indices_factores[4:11]) {
  plot_factor_hist(
    dato1,
    i,
    breaks = seq(min(dato1[,i]) - 0.5,
                 max(dato1[,i]) + 0.5,
                 by = 1)
  )
}

par(mfrow = c(1, 2))# variables- Diagnostico 

for (i in indices_factores[12:13]) {
  plot_factor_hist(
    dato1,
    i,
    breaks = seq(min(dato1[,i]) - 0.5,
                 max(dato1[,i]) + 0.5,
                 by = 1)
  )
}

tablas_factores <- lapply(indices_factores, function(i){
  factor_summary(dato1, i)
})

names(tablas_factores) <- vari[indices_factores]
```
---
### Variables de conteo

Para las variables Expuestos y Enfermos se utilizaron diagramas de caja, permitiendo identificar asimetrías, valores extremos y diferencias en magnitud entre brotes.

```{r}
# Variable de interés principal
par(mfrow = c(1, 2))
boxplot(dato1[, 8], main = "Distribución del número de enfermos",
        ylab = "Enfermos")
boxplot(dato1[, 7], main = "Distribución del número de expuestos",
        ylab = "Expuestos")
```
---

## Modelos de regresión penalizada: LASSO

Se construyó la matriz de diseño mediante model.matrix, incorporando variables categóricas mediante codificación dummy.
La variable respuesta corresponde al número de personas enfermas por brote.

```{r}
# modificacion de extructura de datos para hacer modelo lineal
dato10=data.frame(dato1)
head(dato10)
attach(dato10)

# modelo LASSO
x = model.matrix(Enfermo ~ ., dato10)
y = dato10$Enfermo
```

```{r}
set.seed(1)

n <- nrow(x)
train <- sample(seq_len(n), size = floor(n / 2))
test  <- setdiff(seq_len(n), train)

y.test <- y[test]
grid =10^ seq (10,-2, length =100)
```

Se ajustó un modelo LASSO clásico utilizando la librería glmnet, explorando una grilla logarítmica de valores del parámetro de penalización λ.

```{r}
lasso.mod = glmnet(x[train,], y[train], alpha = 1, lambda = grid)
plot(lasso.mod)
```


```{r}
cv.out <- cv.glmnet(
  x[train, ],
  y[train],
  alpha = 1
)

plot(cv.out)

bestlam <- cv.out$lambda.min
bestlam
```


```{r}
lasso.pred <- predict(
  lasso.mod,
  s = bestlam,
  newx = x[test, ]
)

mse_lasso <- mean((lasso.pred - y.test)^2)
mse_lasso

r2_lasso <- 1 - mean((y.test - lasso.pred)^2) /
                  mean((y.test - mean(y.test))^2)
r2_lasso
```

Los coeficientes distintos de cero representan las variables seleccionadas por
el procedimiento LASSO, las cuales son consideradas relevantes en el análisis.

```{r}
coef_lasso <- as.matrix(coef(lasso.mod, s = bestlam))
coef_no_nulos <- coef_lasso[coef_lasso[,1] != 0, , drop = FALSE]
coef_no_nulos[-1, , drop = FALSE]
```

```{r}
dato_df <- data.frame(dato1)

modelo_poisson <- glm(
  Enfermos ~ . - Año.estadistico - Fallecidos - Tasa.Letalidad,
  data = dato_df,
  family = poisson
)

summary(modelo_poisson)
```

---

## 7. Regularización: LASSO Poisson

Se emplea regularización LASSO para la selección de variables relevantes.

```{r}
library(glmnet)

# Matriz de diseño
x <- model.matrix(Enfermos ~ ., dato_df)
y <- dato_df$Enfermos

# Validación cruzada
cv_lasso <- cv.glmnet(
  x,
  y,
  family = "poisson",
  alpha = 1
)

# Mejor lambda
cv_lasso$lambda.min
```

```{r}
# Coeficientes seleccionados por LASSO
coef(cv_lasso, s = "lambda.min")
```

---

## 8. Análisis de componentes principales (PCA)

Como herramienta exploratoria adicional, se realiza un PCA sobre las variables
explicativas.

```{r}
# Excluir variable respuesta
pca <- prcomp(dato1[, -8], scale. = TRUE)

summary(pca)
```

```{r}
plot(pca, main = "Scree plot")
biplot(pca)
```

---

## 9. Conclusiones

El análisis exploratorio permitió identificar patrones relevantes en la
distribución de síntomas y variables asociadas a los brotes alimentarios.

El modelo Poisson y la regularización LASSO evidencian que un subconjunto reducido
de variables explica gran parte de la variabilidad observada en el número de
enfermos, destacando la utilidad de técnicas de selección de variables en
problemas reales de salud pública.
